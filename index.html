<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Банкротство физических лиц</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #f7f9fb; color: #333; line-height: 1.5; }

    header {
      background: linear-gradient(rgba(10,61,98,0.8), rgba(10,61,98,0.8)),
                  url('https://images.unsplash.com/photo-1521791136064-7986c2920216?auto=format&fit=crop&w=1600&q=80') no-repeat center/cover;
      color: white; text-align: center; padding: 100px 20px;
    }
    header h1 { font-size: 42px; margin-bottom: 20px; }
    header p { font-size: 20px; margin-bottom: 30px; }
    .btn {
      display: inline-block; padding: 14px 28px; background: #ff6b6b;
      color: white; font-weight: bold; border-radius: 8px; text-decoration: none;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.3s;
    }
    .btn:hover { background: #ff4b4b; }

    .section { padding: 60px 20px; max-width: 1100px; margin: auto; }
    .section h2 { text-align: center; font-size: 32px; margin-bottom: 40px; color: #0a3d62; }

    .features { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
    .feature {
      flex: 1 1 300px; background: white; padding: 30px;
      border-radius: 12px; text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: 0.3s;
    }
    .feature:hover { transform: translateY(-5px); }
    .feature img { width: 60px; margin-bottom: 15px; }

    .reviews { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
    .review {
      flex: 1 1 300px; background: #fff; padding: 20px; border-radius: 10px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.1); font-style: italic;
    }
    .review strong { display: block; margin-top: 10px; font-style: normal; }

    footer {
      background: #0a3d62; color: #fff; text-align: center; padding: 30px;
    }

    /* Chat block */
    .chat-container {
      max-width: 900px;
      margin: 40px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      height: 600px;
      overflow: hidden;
    }
    .chat-header {
      background: #0a3d62;
      color: white;
      padding: 15px;
      font-weight: bold;
      text-align: center;
    }
    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #f4f6f9;
    }
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
    }
    .bot {
      background: #eef4f9;
      align-self: flex-start;
    }
    .user {
      background: #ff6b6b;
      color: white;
      align-self: flex-end;
    }
    .chat-suggestions {
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      border-top: 1px solid #ddd;
      background: #fafafa;
    }
    .chat-suggestions button {
      padding: 8px 14px;
      border: none;
      border-radius: 20px;
      background: #eef4f9;
      cursor: pointer;
      font-size: 13px;
      transition: 0.3s;
    }
    .chat-suggestions button:hover {
      background: #d6e4f0;
    }
    .chat-input {
      display: flex;
      border-top: 1px solid #ddd;
    }
    .chat-input input {
      flex: 1;
      padding: 14px;
      border: none;
      outline: none;
      font-size: 14px;
    }
    .chat-input button {
      padding: 0 20px;
      border: none;
      background: #ff6b6b;
      color: white;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chat-input button:hover { background: #ff4b4b; }
    .chat-input button svg { width: 18px; height: 18px; fill: white; }

    /* Popup form */
    #leadOverlay {
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,0.6); z-index:9998;
    }
    #leadPopup, #leadThanks {
      display:none; position:fixed; top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:#fff; color:#333; padding:20px;
      border-radius:16px; z-index:9999;
      max-width:400px; width:90%;
      box-shadow:0 0 20px rgba(0,0,0,0.4);
      text-align:center;
    }
    #leadPopup h3 { margin-bottom:15px; color:#0a3d62; }
    #leadPopup input {
      width:100%; padding:10px; border-radius:8px;
      border:1px solid #ccc; margin-bottom:10px;
    }
    #leadPopup button {
      width:100%; padding:12px;
      border:none; border-radius:8px;
      background-color:#ff6b6b; color:#fff;
      font-weight:bold; cursor:pointer;
    }
    #leadPopup button:hover { background:#ff4b4b; }
  </style>
</head>
<body>
  <header>
    <h1>Банкротство физических лиц</h1>
    <p>Простой путь к финансовой свободе. Юристы + технологии.</p>
    <a href="#scanner" class="btn">Пройти онлайн-сканер</a>
  </header>

  <section id="scanner" class="section">
    <h2>Как это работает</h2>
    <div class="features">
      <div class="feature">
        <img src="https://img.icons8.com/color/96/contract.png"/>
        <h3>Онлайн-сканер</h3>
        <p>Пройдите быструю проверку и узнайте, подходит ли вам банкротство.</p>
      </div>
      <div class="feature">
        <img src="https://img.icons8.com/color/96/artificial-intelligence.png"/>
        <h3>AI-ассистент</h3>
        <p>Ответит на вопросы 24/7 и поможет разобраться в деталях.</p>
      </div>
      <div class="feature">
        <img src="https://img.icons8.com/color/96/movies-folder.png"/>
        <h3>Кейсы клиентов</h3>
        <p>Реальные истории и видео-отзывы людей, которые уже прошли процедуру.</p>
      </div>
    </div>

    <!-- Chat -->
    <div class="chat-container">
      <div class="chat-header">Онлайн-консультант</div>
      <div class="chat-messages" id="chat"></div>
      <div class="chat-suggestions">
        <button onclick="quickSend('Какие долги списываются?')">Какие долги списываются?</button>
        <button onclick="quickSend('Сколько стоит?')">Сколько стоит?</button>
        <button onclick="quickSend('Записаться на консультацию')">Записаться на консультацию</button>
      </div>
      <div class="chat-input">
        <button onclick="startVoice()" title="Говорить">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M192 256c0 17.7-14.3 32-32 32s-32-14.3-32-32V128c0-17.7 14.3-32 32-32s32 14.3 32 32V256zM160 320c35.3 0 64-28.7 64-64V128a64 64 0 1 0-128 0V256c0 35.3 28.7 64 64 64zm56 32H104c-13.3 0-24 10.7-24 24s10.7 24 24 24h24v56c0 13.3 10.7 24 24 24s24-10.7 24-24V400h24c13.3 0 24-10.7 24-24s-10.7-24-24-24z"/></svg>
        </button>
        <input type="text" id="chatInput" placeholder="Введите ваш вопрос...">
        <button onclick="sendMessage()">Отправить</button>
      </div>
    </div>
  </section>

  <footer>
    © 2025. Центр банкротства. Бесплатная консультация: 8-800-000-00-00
  </footer>

  <!-- Overlay + Form + Thanks -->
<div id="leadOverlay"></div>

<div id="leadPopup">
  <h3 id="leadTitle">Оставьте заявку</h3>
  <input id="leadName" placeholder="Ваше имя">
  <input id="leadPhone" placeholder="+7 (___) ___-__-__">
  <button id="leadSubmitBtn">Оставить заявку</button>
</div>

<div id="leadThanks">
  <div>✅ Спасибо за заявку, скоро свяжемся с вами</div>
</div>

<script src="https://unpkg.com/imask"></script>
<script>
  const OPENAI_PROXY_URL = "https://openai-gpt-proxy-mcnj.onrender.com/gpt";
  const LEAD_URL = "https://openai-gpt-proxy-mcnj.onrender.com/lead";

  let messages = [];
  const chatBox = document.getElementById("chat");
  const chatInput = document.getElementById("chatInput");

  function appendMessage(text, fromUser=false){
    const div = document.createElement("div");
    div.className = "message " + (fromUser ? "user" : "bot");
    div.textContent = text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

 // глобально сверху добавь:
let userId = localStorage.getItem("userId") || "user_" + Math.random().toString(36).substr(2,9);
localStorage.setItem("userId", userId);

// а саму функцию полностью замени:
async function sendMessage(){
  const text = chatInput.value.trim();
  if(!text) return;
  appendMessage(text,true);
  messages.push({role:"user", content:text});
  chatInput.value="";

  try {
    const res = await fetch(OPENAI_PROXY_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ messages, userId, mode:"bankruptcy" })
    });
    const data = await res.json();
    let reply = data.choices?.[0]?.message?.content || "Ошибка";

    // ловим [openLeadForm] или triggerForm
    if(/\[openLeadForm\]/i.test(reply) || data.triggerForm){
      const clean = reply.replace(/\[openLeadForm\]/gi,"").trim();
      document.getElementById("leadTitle").innerText = clean || "Оставьте заявку";
      openLeadForm();
      reply = clean;
    }

    appendMessage(reply,false);
    messages.push({role:"assistant", content:reply});
  } catch(e){
    appendMessage("Ошибка соединения",false);
  }
}

  function quickSend(text){
    chatInput.value=text;
    sendMessage();
  }

  function startVoice(){
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "ru-RU";
    recognition.start();
    recognition.onresult = (e)=>{
      const text = e.results[0][0].transcript;
      chatInput.value=text;
      sendMessage();
    };
    recognition.onerror=()=>alert("Ошибка распознавания");
  }

  chatInput.addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  window.addEventListener("load",()=>{
    setTimeout(()=>{
      if(messages.length===0){
        appendMessage("Здравствуйте! Я помогу вам разобраться с процедурой банкротства.",false);
      }
    },1000);
  });

  // === Форма ===
  IMask(document.getElementById("leadPhone"), { mask: "+{7} (000) 000-00-00" });

  function openLeadForm(){
    document.getElementById("leadOverlay").style.display="block";
    document.getElementById("leadPopup").style.display="block";
  }

  document.getElementById("leadOverlay").addEventListener("click", closeLeadForms);
  function closeLeadForms(){
    document.getElementById("leadOverlay").style.display="none";
    document.getElementById("leadPopup").style.display="none";
    document.getElementById("leadThanks").style.display="none";
  }

  document.getElementById("leadSubmitBtn").addEventListener("click", async ()=>{
  const name = document.getElementById("leadName").value.trim();
  let phone = document.getElementById("leadPhone").value.replace(/\D/g,""); 

  if(!name || phone.length < 10){ 
    alert("Введите имя и корректный номер телефона"); 
    return; 
  }

  // нормализуем к виду +7XXXXXXXXXX
  phone = "+7" + phone.slice(-10);

  const payload = { name, phone, userId, messages };

  document.getElementById("leadPopup").style.display="none";
  document.getElementById("leadThanks").style.display="block";

  setTimeout(closeLeadForms, 3000);

  try {
    await fetch(LEAD_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
  }catch(e){ console.error("Ошибка отправки",e); }
});
</script>
</body>
</html>
